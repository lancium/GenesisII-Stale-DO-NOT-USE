<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="scripts" name="GenesisII.scripts">

	<target name="build-script-win" if="windows.scripts">
		<copy file="${win-script-src-dir}/${win-script-base-name}.bat"
			tofile="${basedir}/${win-script-base-name}.bat"/>
		<replace file="${basedir}/${win-script-base-name}.bat"
			token="$INSTALL_PATH" value="${basedir}" summary="no"/>
		<replace file="${basedir}/${win-script-base-name}.bat"
			token="$LOG4JCONFIG" value="genesisII.container.log4j.properties"
			summary="no"/>
		<replace file="${basedir}/${win-script-base-name}.bat"
			token="$CLIENT_LOG4JCONFIG" value="genesisII.client.log4j.properties"
			summary="no"/>
		<antcall target="set-jni">
			<param name="build-target-file" value="${basedir}/${win-script-base-name}.bat"/>
		</antcall>
	</target>

	<target name="build-script-unix" if="unix.scripts">
		<copy file="${unix-script-src-dir}/${unix-script-base-name}"
			tofile="${basedir}/${unix-script-base-name}"/>
		<replace file="${basedir}/${unix-script-base-name}"
			token="%{INSTALL_PATH}" value="${basedir}" summary="no"/>
		<replace file="${basedir}/${unix-script-base-name}"
			token="%{LOG4JCONFIG}" value="genesisII.container.log4j.properties"
			summary="no"/>
		<replace file="${basedir}/${unix-script-base-name}"
			token="%{CLIENT_LOG4JCONFIG}" value="genesisII.client.log4j.properties"
			summary="no"/>
		<antcall target="set-jni">
			<param name="build-target-file" value="${basedir}/${unix-script-base-name}"/>
		</antcall>
		
		<antcall target="set-mac-java">
                        <param name="build-target-file" value="${basedir}/${unix-script-base-name}"/>
        </antcall>
		
		<chmod file="${basedir}/${unix-script-base-name}" perm="755"/>
	</target>
	
	<target name="set-mac-java" if="mac.scripts">
		<replace file="${build-target-file}"
                        token="$JAVA_HOME/bin/java" value="java"
                        summary="no"/>
	</target>

	<target name="set-jni">
		<antcall target="jni-lin32" />
		<antcall target="jni-lin64" />
		<antcall target="jni-win32" />
		<antcall target="jni-osx64" />
	</target>

	<target name="jni-lin32" if="linux.32">
		<antcall target="set-jni-replace">
			<param name="build-target-jni" value="jni-libs/lin32"/>
		</antcall>
	</target>
	
	<target name="jni-lin64" if="linux.64">
		<antcall target="set-jni-replace">
			<param name="build-target-jni" value="jni-libs/lin64"/>
		</antcall>
	</target>
	
	<target name="jni-win32" if="windows.scripts">
		<antcall target="set-jni-replace">
			<param name="build-target-jni" value="jni-libs/win32"/>
		</antcall>
	</target>
	
	<target name="jni-osx64" if="mac.scripts">
		<antcall target="set-jni-replace">
			<param name="build-target-jni" value="jni-libs/osx64"/>
		</antcall>
	</target>
	
	<target name="set-jni-replace">
		<replace file="${build-target-file}"
					token="%{GENII_JNI_PATH}" value="${build-target-jni}"
					summary="no"/>
	</target>
		
	
	<target name="build-script">
		<antcall target="build-script-win">
			<param name="win-script-src-dir" value="${script-src-dir}"/>
			<param name="win-script-base-name" value="${script-base-name}"/>
		</antcall>
		<antcall target="build-script-unix">
			<param name="unix-script-src-dir" value="${script-src-dir}"/>
			<param name="unix-script-base-name" value="${script-base-name}"/>
		</antcall>
	</target>
	
	<target name="clean-all-scripts">
		<delete quiet="true">
			<fileset dir="${basedir}">
				<include name="jserver.*"/>
				<include name="jserver-debug.*"/>
				<include name="runContainer.*"/>
				<include name="grid*"/>
				<include name="ifs.bat"/>
				<include name="simple-command*"/>
				<include name="cert-tool*"/>
				<include name="initialize-new-net-security*"/>
				<include name="connect-new-client*"/>
				<include name="windows-start-wrapper.bat"/>
				<include name="windows-cmd-runner.bat"/>
				<include name="VCGRContainerDaemon"/>
				<include name="linux-cmd-wrapper"/>
			</fileset>
		</delete>
	</target>
		
	<target name="scripts">
		<condition property="unix.scripts">
			<os family="unix"/>
		</condition>
		<condition property="mac.scripts">
			<os family="mac"/>
		</condition>
		<condition property="windows.scripts">
			<os family="windows"/>
		</condition>
		<condition property="linux.scripts">
			<and>
			    <isset property="unix.scripts" />
			    <not>
				<isset property="mac.scripts" />
			    </not>
     			</and>
 		</condition>

		
		<condition property="linux.64">
			<and>
				<isset property="linux.scripts" />
				<equals arg1="${build.targetArch}" arg2="64"/>
			</and>
		</condition>
		
		<condition property="linux.32">
			<and>
				<isset property="linux.scripts" />
				<not>
					<isset property="linux.64" />
				</not>
			</and>
    		</condition>
		
			
		<copy file="${scripts.dir}/jar-desc.xml"
			tofile="${basedir}/jar-desc.xml"/>
		<replace file="${basedir}/jar-desc.xml"
			token="${installer:sys.installationDir}" value="${basedir}" summary="no"/>

		<copy file="${scripts.dir}/genii-base-application.properties"
			tofile="${basedir}/ApplicationWatcher/genii-base-application.properties"/>
		<replace file="${basedir}/ApplicationWatcher/genii-base-application.properties"
			token="${installer:sys.installationDir}" value="${basedir}" summary="no"/>
		<replace file="${basedir}/ApplicationWatcher/genii-base-application.properties"
			token="\" value="\\" summary="no"/>
		<replace file="${basedir}/ApplicationWatcher/genii-base-application.properties"
			token="${installer:genii.deployment}" value="unspecified" summary="no"/>
		<replace file="${basedir}/ApplicationWatcher/genii-base-application.properties"
			token="${installer:genii.patch-url}" value="http://www.tempuri.org" summary="no"/>

		<copy file="${scripts.dir}/genii-container-application.properties"
			tofile="${basedir}/ApplicationWatcher/genii-container-application.properties"/>
		<replace file="${basedir}/ApplicationWatcher/genii-container-application.properties"
			token="${installer:sys.installationDir}" value="${basedir}" summary="no"/>
		<replace file="${basedir}/ApplicationWatcher/genii-container-application.properties"
			token="\" value="\\" summary="no"/>

		<copy file="${scripts.dir}/genii-update-application.properties"
			tofile="${basedir}/ApplicationWatcher/genii-update-application.properties"/>
		<replace file="${basedir}/ApplicationWatcher/genii-update-application.properties"
			token="${installer:sys.installationDir}" value="${basedir}" summary="no"/>
		<replace file="${basedir}/ApplicationWatcher/genii-update-application.properties"
			token="\" value="\\" summary="no"/>

		<copy file="${scripts.dir}/genii-client-application.properties"
			tofile="${basedir}/ApplicationWatcher/genii-client-application.properties"/>
		<replace file="${basedir}/ApplicationWatcher/genii-client-application.properties"
			token="${installer:sys.installationDir}" value="${basedir}" summary="no"/>
		<replace file="${basedir}/ApplicationWatcher/genii-client-application.properties"
			token="\" value="\\" summary="no"/>

		<copy file="${scripts.dir}/genii-simple-application.properties"
			tofile="${basedir}/ApplicationWatcher/genii-simple-application.properties"/>
		<replace file="${basedir}/ApplicationWatcher/genii-simple-application.properties"
			token="${installer:sys.installationDir}" value="${basedir}" summary="no"/>
		<replace file="${basedir}/ApplicationWatcher/genii-simple-application.properties"
			token="\" value="\\" summary="no"/>

		<copy file="${scripts.dir}/genii-certtool-application.properties"
			tofile="${basedir}/ApplicationWatcher/genii-certtool-application.properties"/>
		<replace file="${basedir}/ApplicationWatcher/genii-certtool-application.properties"
			token="${installer:sys.installationDir}" value="${basedir}" summary="no"/>
		<replace file="${basedir}/ApplicationWatcher/genii-certtool-application.properties"
			token="\" value="\\" summary="no"/>

		<copy file="${scripts.dir}/genii-ogrshserv-application.properties"
			tofile="${basedir}/ApplicationWatcher/genii-ogrshserv-application.properties"/>
		<replace file="${basedir}/ApplicationWatcher/genii-ogrshserv-application.properties"
			token="${installer:sys.installationDir}" value="${basedir}" summary="no"/>
		<replace file="${basedir}/ApplicationWatcher/genii-ogrshserv-application.properties"
			token="\" value="\\" summary="no"/>

		<copy file="${scripts.dir}/jserver-jar-desc.xml"
			tofile="${basedir}/jserver-jar-desc.xml"/>
		<replace file="${basedir}/jserver-jar-desc.xml"
			token="${installer:sys.installationDir}" value="${basedir}" summary="no"/>
		<replace file="${basedir}/jserver-jar-desc.xml"
			token="$LOG4JCONFIG" value="genesisII.container.log4j.properties"
			summary="no"/>
		<replace file="${basedir}/jserver-jar-desc.xml"
			token="$CLIENT_LOG4JCONFIG" value="genesisII.client.log4j.properties"
			summary="no"/>

		<antcall target="build-script-win">
			<param name="win-script-src-dir" value="${scripts.dir}"/>
			<param name="win-script-base-name" value="runContainer"/>
		</antcall>
		<antcall target="build-script-unix">
			<param name="unix-script-src-dir" value="${scripts.dir}"/>
			<param name="unix-script-base-name" value="runContainer.sh"/>
		</antcall>
		<antcall target="build-script">
			<param name="script-src-dir" value="${scripts.dir}"/>
			<param name="script-base-name" value="grid"/>
		</antcall>
		<antcall target="build-script-win">
			<param name="win-script-src-dir" value="${scripts.dir}"/>
			<param name="win-script-base-name" value="ifs"/>
		</antcall>
		<antcall target="build-script">
			<param name="script-src-dir" value="${scripts.dir}"/>
			<param name="script-base-name" value="simple-command"/>
		</antcall>
		<antcall target="build-script">
			<param name="script-src-dir" value="${scripts.dir}"/>
			<param name="script-base-name" value="cert-tool"/>
		</antcall>
		<antcall target="build-script-win">
			<param name="win-script-src-dir" value="${scripts.dir}"/>
			<param name="win-script-base-name" value="windows-start-wrapper"/>
		</antcall>
		<antcall target="build-script-win">
			<param name="win-script-src-dir" value="${scripts.dir}"/>
			<param name="win-script-base-name" value="windows-cmd-runner"/>
		</antcall>
		<antcall target="build-script-unix">
			<param name="unix-script-src-dir" value="${scripts.dir}"/>
			<param name="unix-script-base-name" value="linux-cmd-wrapper"/>
		</antcall>
	</target>

</project>
